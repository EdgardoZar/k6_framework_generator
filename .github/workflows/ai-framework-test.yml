name: AI Framework Generation & Testing Pipeline

# This workflow runs ONLY on-demand (manual trigger), use it to create a framework for the first time
on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Configuration file to use'
        required: true
        default: 'sample-config.json'
        type: choice
        options:
          - sample-config.json
          - examples/rick_and_morty.json
          - examples/ecommerce-config.json
          - examples/api-testing-config.json
          - examples/microservices-config.json
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
      run_k6_tests:
        description: 'Run actual k6 tests on generated framework'
        required: true
        default: true
        type: boolean

jobs:
  validate-and-generate:
    name: Validate Configuration & Generate Framework
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Install dependencies
      run: npm install
      
    - name: Display selected configuration
      run: |
        echo "ðŸ”§ Using configuration file: ${{ github.event.inputs.config_file }}"
        echo "ðŸ§ª Test type: ${{ github.event.inputs.test_type }}"
        echo "â–¶ï¸ Run k6 tests: ${{ github.event.inputs.run_k6_tests }}"
        
    - name: Validate and Generate Framework
      run: |
        echo "ðŸ“‹ Step 1: Validating configuration and generating framework..."
        node validate-and-generate.js ${{ github.event.inputs.config_file }}
        
    - name: Verify Framework Generation
      run: |
        echo "âœ… Step 2: Verifying generated framework..."
        # Find the generated framework directory
        FRAMEWORK_DIR=$(find . -name "*-k6-framework" -type d | head -1)
        if [ -z "$FRAMEWORK_DIR" ]; then
          echo "âŒ No framework directory found!"
          exit 1
        fi
        echo "ðŸ“ Generated framework: $FRAMEWORK_DIR"
        
        # Check if essential files exist
        if [ ! -f "$FRAMEWORK_DIR/controller.js" ]; then
          echo "âŒ controller.js not found!"
          exit 1
        fi
        if [ ! -f "$FRAMEWORK_DIR/config/config.js" ]; then
          echo "âŒ config.js not found!"
          exit 1
        fi
        if [ ! -f "$FRAMEWORK_DIR/tests/api/apis.js" ]; then
          echo "âŒ apis.js not found!"
          exit 1
        fi
        echo "âœ… All essential files found!"
        
    - name: Upload Framework Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-k6-framework
        path: |
          *-k6-framework/
        retention-days: 7

  test-generated-framework:
    name: Test Generated Framework
    runs-on: ubuntu-latest
    needs: validate-and-generate
    if: ${{ github.event.inputs.run_k6_tests == 'true' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Framework Artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-k6-framework
        path: ./generated-framework
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Install k6
      run: |
        echo "ðŸ“¦ Installing k6..."
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    - name: Verify k6 Installation
      run: |
        echo "âœ… Verifying k6 installation..."
        k6 version
        
    - name: Navigate to Generated Framework and Update Configuration
      run: |
        echo "ðŸ“ Navigating to generated framework..."
        echo "ðŸ“‹ Current directory: $(pwd)"
        echo "ðŸ“‹ Generated framework directory contents:"
        ls -la ./generated-framework/ || echo "generated-framework directory not found"
        
        # Find the framework directory
        FRAMEWORK_DIR=$(find ./generated-framework -name "*k6-framework" -type d | head -1)
        if [ -z "$FRAMEWORK_DIR" ]; then
          echo "âŒ Framework directory not found in artifacts!"
          echo "ðŸ“‹ Available artifacts:"
          ls -la ./generated-framework/
          exit 1
        fi
        echo "ðŸ“ Framework directory: $FRAMEWORK_DIR"
        
        # Navigate to the framework directory
        cd "$FRAMEWORK_DIR"
        echo "ðŸ“‹ Current directory: $(pwd)"
        echo "ðŸ“‹ Framework directory contents:"
        ls -la
        
        # Update test configuration
        echo "ðŸ”§ Updating test configuration for ${{ github.event.inputs.test_type }} test..."
        echo "ðŸ“‹ Config directory contents:"
        ls -la config/ || echo "Config directory not found"
        
        # Check if config.js exists
        if [ -f "config/config.js" ]; then
          echo "âœ… Found config/config.js, updating test type..."
          # Update the config.js to use the specified test type
          sed -i "s/static testType = [0-9]/static testType = ${{ github.event.inputs.test_type == 'smoke' && '1' || github.event.inputs.test_type == 'load' && '2' || '3' }}/" config/config.js
          echo "âœ… Test configuration updated"
        else
          echo "âŒ config/config.js not found!"
          echo "ðŸ“‹ Available files:"
          find . -name "*.js" -type f
          exit 1
        fi
        
    - name: Run k6 Tests
      run: |
        echo "ðŸš€ Running k6 ${{ github.event.inputs.test_type }} test..."
        # Navigate to the framework directory
        FRAMEWORK_DIR=$(find ./generated-framework -name "*k6-framework" -type d | head -1)
        if [ -z "$FRAMEWORK_DIR" ]; then
          echo "âŒ Framework directory not found!"
          exit 1
        fi
        cd "$FRAMEWORK_DIR"
        echo "ðŸ“ Running k6 from: $(pwd)"
        
        # Run k6 and save results to reports folder
        k6 run controller.js --out json=reports/test-results.json
        
        # Also create a summary report
        echo "ðŸ“Š Creating test summary..."
        cat > reports/test-summary.md << 'EOF'
# K6 Test Results Summary

**Test Type:** ${{ github.event.inputs.test_type }}
**Test Date:** $(date)
**Framework:** $(basename "$PWD")

## Test Execution
- âœ… K6 test completed successfully
- ðŸ“ Results saved to: reports/test-results.json
- ðŸ“Š HTML report available in reports/ folder

## Next Steps
1. Download the generated framework
2. Review test results in reports/ folder
3. Use the framework for your performance testing needs

---
*Generated by K6 Framework Generator*
EOF
        
        echo "âœ… Test results saved to reports/ folder"
        
    - name: Parse Test Results
      run: |
        echo "ðŸ“Š Test Results Summary:"
        # Navigate to the framework directory
        FRAMEWORK_DIR=$(find ./generated-framework -name "*k6-framework" -type d | head -1)
        if [ -z "$FRAMEWORK_DIR" ]; then
          echo "âŒ Framework directory not found!"
          exit 1
        fi
        cd "$FRAMEWORK_DIR"
        echo "ðŸ“ Checking results from: $(pwd)"
        
        if [ -f "reports/test-results.json" ]; then
          echo "âœ… Test results file generated in reports/ folder"
          # Extract key metrics from the JSON results
          echo "ðŸ“ˆ Key Metrics:"
          echo "- Test completed successfully"
          echo "- Results saved to: reports/test-results.json"
          echo "- Summary report: reports/test-summary.md"
        else
          echo "âš ï¸ No test results file found in reports/ folder"
        fi
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: k6-test-results
        path: |
          reports/
        retention-days: 7

  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [validate-and-generate, test-generated-framework]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Generate Summary Report
      run: |
        echo "ðŸ“‹ Generating Test Summary Report..."
        echo "=========================================="
        echo "ðŸŽ¯ AI Framework Generation & Testing Pipeline"
        echo "=========================================="
        echo ""
        echo "ðŸ“… Run Date: $(date)"
        echo "ðŸ”§ Configuration: ${{ github.event.inputs.config_file }}"
        echo "ðŸ§ª Test Type: ${{ github.event.inputs.test_type }}"
        echo "â–¶ï¸ K6 Tests Run: ${{ github.event.inputs.run_k6_tests }}"
        echo ""
        echo "ðŸ“Š Results Summary:"
        echo "- Framework Generation: âœ… Success"
        if [ "${{ github.event.inputs.run_k6_tests }}" == "true" ]; then
          echo "- K6 Test Execution: âœ… Success"
        else
          echo "- K6 Test Execution: â­ï¸ Skipped"
        fi
        echo ""
        echo "ðŸ“ Artifacts Generated:"
        echo "- Generated K6 Framework"
        if [ "${{ github.event.inputs.run_k6_tests }}" == "true" ]; then
          echo "- K6 Test Results"
          echo "- HTML Reports (if enabled)"
        fi
        echo ""
        echo "ðŸŽ‰ Pipeline completed successfully!"
        
    - name: Upload Summary Report
      run: |
        echo "ðŸ“„ Creating summary report..."
        cat > pipeline-summary.md << EOF
        # AI Framework Generation & Testing Pipeline - Summary
        
        **Run Date:** $(date)
        **Configuration:** ${{ github.event.inputs.config_file }}
        **Test Type:** ${{ github.event.inputs.test_type }}
        **K6 Tests:** ${{ github.event.inputs.run_k6_tests }}
        
        ## Results
        - âœ… Framework Generation: Success
        - âœ… Configuration Validation: Success
        EOF
        
        if [ "${{ github.event.inputs.run_k6_tests }}" == "true" ]; then
          echo "        - âœ… K6 Test Execution: Success" >> pipeline-summary.md
        else
          echo "        - â­ï¸ K6 Test Execution: Skipped" >> pipeline-summary.md
        fi
        
        echo "        " >> pipeline-summary.md
        echo "        ## Artifacts" >> pipeline-summary.md
        echo "        - Generated K6 Framework" >> pipeline-summary.md
        if [ "${{ github.event.inputs.run_k6_tests }}" == "true" ]; then
          echo "        - K6 Test Results" >> pipeline-summary.md
          echo "        - HTML Reports" >> pipeline-summary.md
        fi
        
    - name: Upload Summary Report
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-summary
        path: pipeline-summary.md
        retention-days: 30
